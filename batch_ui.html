<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>G√©n√©rateur Batch - Compr√©hension Orale</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            max-width: 800px;
            width: 100%;
            padding: 40px;
        }

        .header {
            margin-bottom: 40px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            font-size: 28px;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 30px;
        }

        .form-group label {
            display: block;
            margin-bottom: 12px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .file-input-wrapper {
            position: relative;
            display: inline-block;
            width: 100%;
        }

        .file-input-wrapper input[type="file"] {
            display: none;
        }

        .file-button {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            padding: 12px 16px;
            background: #f5f5f5;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #666;
        }

        .file-button:hover {
            background: #f9f9f9;
            border-color: #667eea;
        }

        .file-button.active {
            background: #f0f4ff;
            border-color: #667eea;
            color: #667eea;
        }

        .file-name {
            font-weight: 500;
            color: #333;
        }

        .icon {
            font-size: 16px;
        }

        .languages-section {
            background: #f9f9f9;
            border-radius: 8px;
            padding: 16px;
        }

        .languages-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .languages-header h3 {
            font-size: 14px;
            color: #333;
            font-weight: 600;
        }

        .select-all-buttons {
            display: flex;
            gap: 8px;
        }

        .select-all-buttons button {
            padding: 6px 12px;
            font-size: 12px;
            border: 1px solid #e0e0e0;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .select-all-buttons button:hover {
            border-color: #667eea;
            color: #667eea;
        }

        .languages-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 12px;
        }

        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-wrapper input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
        }

        .checkbox-wrapper label {
            margin: 0;
            cursor: pointer;
            font-weight: normal;
            font-size: 14px;
            color: #333;
        }

        .select-dropdown {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background: white;
            cursor: pointer;
            transition: border-color 0.2s;
        }

        .select-dropdown:hover {
            border-color: #667eea;
        }

        .select-dropdown:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .text-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            color: #333;
            background: white;
            transition: border-color 0.2s;
        }

        .text-input:hover {
            border-color: #667eea;
        }

        .text-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .prompt-textarea {
            width: 100%;
            min-height: 200px;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 6px;
            font-size: 14px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            color: #333;
            background: #fafafa;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .prompt-textarea:hover {
            border-color: #667eea;
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .button-group {
            display: flex;
            gap: 12px;
            margin-top: 30px;
        }

        .btn {
            flex: 1;
            padding: 14px 24px;
            font-size: 16px;
            font-weight: 600;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-secondary {
            background: #f0f0f0;
            color: #333;
        }

        .btn-secondary:hover:not(:disabled) {
            background: #e0e0e0;
        }

        .status-message {
            margin-top: 20px;
            padding: 16px;
            border-radius: 6px;
            display: none;
            font-size: 14px;
        }

        .status-message.info {
            background: #e3f2fd;
            color: #1976d2;
            border: 1px solid #90caf9;
            display: block;
        }

        .status-message.success {
            background: #e8f5e9;
            color: #388e3c;
            border: 1px solid #81c784;
            display: block;
        }

        .status-message.error {
            background: #ffebee;
            color: #d32f2f;
            border: 1px solid #ef5350;
            display: block;
        }

        .status-message.warning {
            background: #fff3e0;
            color: #f57c00;
            border: 1px solid #ffb74d;
            display: block;
        }

        .progress-section {
            margin-top: 20px;
            display: none;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
        }

        .progress-text {
            font-size: 12px;
            color: #666;
            text-align: center;
        }

        .output-section {
            margin-top: 20px;
            display: none;
        }

        .output-header {
            font-weight: 600;
            color: #333;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .output-box {
            background: #f5f5f5;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            padding: 12px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            color: #333;
            line-height: 1.5;
        }

        .spinner {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 8px;
            border: 2px solid #f3f3f3;
            border-top: 2px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            vertical-align: middle;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .error-details {
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid currentColor;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üöÄ G√©n√©rateur Batch</h1>
            <p>Cr√©ez plusieurs ressources audio en une seule op√©ration</p>
        </div>

        <form id="batchForm">
            <!-- Prompt Input -->
            <div class="form-group">
                <label for="promptText">üìù Prompts (format Markdown)</label>
                <textarea 
                    id="promptText" 
                    name="promptText" 
                    class="prompt-textarea" 
                    placeholder="Collez vos prompts au format:\n1. Premier prompt\n2. Deuxi√®me prompt\n3. Troisi√®me prompt\n..."
                    required
                ></textarea>
                <small style="color: #666; font-size: 12px; margin-top: 8px; display: block;">
                    Format attendu : liste num√©rot√©e en Markdown (1. Premier prompt, 2. Deuxi√®me prompt, etc.)
                </small>
            </div>

            <!-- Languages Selection -->
            <div class="form-group">
                <label>üåç Langues</label>
                <div class="languages-section">
                    <div class="languages-header">
                        <h3>S√©lectionner les langues:</h3>
                        <div class="select-all-buttons">
                            <button type="button" id="selectAllBtn" class="select-all-btn">Tout cocher</button>
                            <button type="button" id="deselectAllBtn" class="deselect-all-btn">Tout d√©cocher</button>
                        </div>
                    </div>
                    <div class="languages-grid" id="languagesGrid"></div>
                </div>
            </div>

            <!-- Level Selection -->
            <div class="form-group">
                <label for="level">üìä Niveau CECRL</label>
                <select id="level" name="level" class="select-dropdown" required>
                    <option value="">-- S√©lectionner un niveau --</option>
                    <option value="A1">A1 - D√©butant</option>
                    <option value="A2">A2 - Faux d√©butant</option>
                    <option value="B1">B1 - Interm√©diaire</option>
                    <option value="B2">B2 - Interm√©diaire sup√©rieur</option>
                    <option value="C1">C1 - Avanc√©</option>
                    <option value="C2">C2 - Ma√Ætrise</option>
                </select>
            </div>

            <!-- Delay Between Generations -->
            <div class="form-group">
                <label for="delay">‚è≥ D√©lai entre g√©n√©rations (secondes)</label>
                <input type="number" id="delay" name="delay" class="text-input" min="0" max="120" step="0.5" value="40" required>
                <small style="color: #666; font-size: 12px; margin-top: 8px; display: block;">Temps entre chaque ressource. D√©faut: 40s (monter si 429 persistants).</small>
            </div>

            <!-- SSML Option -->
            <div class="form-group">
                <div class="checkbox-wrapper">
                    <input type="checkbox" id="ssml" name="ssml" value="1">
                    <label for="ssml">üéØ Utiliser SSML pour emphases et pauses</label>
                </div>
                <small style="color: #666; font-size: 12px; margin-top: 8px; display: block;">Active la conversion des marqueurs Markdown (* ** [p]) en balises SSML pour la synth√®se audio.</small>
            </div>

            <!-- Buttons -->
            <div class="button-group">
                <button type="submit" class="btn btn-primary" id="submitBtn">
                    ‚ú® Cr√©er les documents et mettre le site √† jour
                </button>
                <button type="reset" class="btn btn-secondary">‚Üª R√©initialiser</button>
            </div>
        </form>

        <!-- Status Message -->
        <div class="status-message" id="statusMessage"></div>

        <!-- Progress Section -->
        <div class="progress-section" id="progressSection">
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-text" id="progressText">En attente...</div>
        </div>

        <!-- Output Section -->
        <div class="output-section" id="outputSection">
            <div class="output-header">üìã Sortie du serveur:</div>
            <div class="output-box" id="outputBox"></div>
        </div>
    </div>

    <script>
        const LANGUAGES = [
            { code: 'fr', name: 'Fran√ßais', region: 'FR' },
            { code: 'nl', name: 'N√©erlandais', region: 'NL' },
            { code: 'eng', name: 'Anglais UK', region: 'UK' },
            { code: 'us', name: 'Anglais US', region: 'US' },
            { code: 'esp', name: 'Espagnol', region: 'ES' },
            { code: 'hisp', name: 'Espagnol Am√©rique', region: 'HISP' },
            { code: 'all', name: 'Allemand', region: 'DE' },
            { code: 'cor', name: 'Cor√©en', region: 'KR' },
            { code: 'it', name: 'Italien', region: 'IT' }
        ];

        let selectedLanguages = new Set();

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initializeLanguagesGrid();
            setupEventListeners();
        });

        function initializeLanguagesGrid() {
            const grid = document.getElementById('languagesGrid');
            grid.innerHTML = '';
            
            LANGUAGES.forEach(lang => {
                const wrapper = document.createElement('div');
                wrapper.className = 'checkbox-wrapper';
                
                const input = document.createElement('input');
                input.type = 'checkbox';
                input.id = `lang-${lang.code}`;
                input.value = lang.code;
                input.addEventListener('change', (e) => {
                    if (e.target.checked) {
                        selectedLanguages.add(lang.code);
                    } else {
                        selectedLanguages.delete(lang.code);
                    }
                });
                
                const label = document.createElement('label');
                label.htmlFor = `lang-${lang.code}`;
                label.textContent = lang.name;
                
                wrapper.appendChild(input);
                wrapper.appendChild(label);
                grid.appendChild(wrapper);
            });
        }

        function setupEventListeners() {
            // Select all buttons
            document.getElementById('selectAllBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = true;
                    selectedLanguages.add(cb.value);
                });
            });

            document.getElementById('deselectAllBtn').addEventListener('click', (e) => {
                e.preventDefault();
                document.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                    cb.checked = false;
                    selectedLanguages.delete(cb.value);
                });
            });

            // Form submission
            document.getElementById('batchForm').addEventListener('submit', handleSubmit);
        }

        function showStatus(message, type = 'info') {
            const el = document.getElementById('statusMessage');
            el.textContent = message;
            el.className = `status-message ${type}`;
        }

        function hideStatus() {
            document.getElementById('statusMessage').className = 'status-message';
        }

        function updateProgress(current, total, message = '') {
            const section = document.getElementById('progressSection');
            section.style.display = 'block';
            
            const percent = (current / total) * 100;
            document.getElementById('progressFill').style.width = percent + '%';
            
            const text = message || `${current} / ${total} ressources`;
            document.getElementById('progressText').textContent = text;
        }

        function appendOutput(text) {
            const box = document.getElementById('outputBox');
            box.textContent += text + '\n';
            box.scrollTop = box.scrollHeight;
        }

        async function handleSubmit(e) {
            e.preventDefault();

            // Validation
            if (selectedLanguages.size === 0) {
                showStatus('‚ùå Veuillez s√©lectionner au moins une langue', 'error');
                return;
            }

            const level = document.getElementById('level').value;
            if (!level) {
                showStatus('‚ùå Veuillez s√©lectionner un niveau', 'error');
                return;
            }

            const promptText = document.getElementById('promptText').value.trim();
            if (!promptText) {
                showStatus('‚ùå Veuillez coller vos prompts', 'error');
                return;
            }

            // Prepare form data
            const formData = new FormData();
            formData.append('promptText', promptText);
            formData.append('level', level);
            formData.append('languages', Array.from(selectedLanguages).join(','));
            formData.append('delay', document.getElementById('delay').value);

            // Disable submit button
            const submitBtn = document.getElementById('submitBtn');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner"></span>En cours...';

            // Clear output
            document.getElementById('outputBox').textContent = '';
            document.getElementById('outputSection').style.display = 'none';
            document.getElementById('progressSection').style.display = 'none';

            hideStatus();

            try {
                const response = await fetch('/api/batch-generate', {
                    method: 'POST',
                    body: formData
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let buffer = '';

                document.getElementById('outputSection').style.display = 'block';

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    buffer += decoder.decode(value, { stream: true });
                    const lines = buffer.split('\n');
                    buffer = lines.pop();

                    for (const line of lines) {
                        if (!line.trim()) continue;

                        try {
                            const data = JSON.parse(line);
                            
                            if (data.type === 'output') {
                                appendOutput(data.message);
                            } else if (data.type === 'progress') {
                                updateProgress(data.current, data.total, data.message);
                            } else if (data.type === 'status') {
                                showStatus(data.message, data.status);
                            } else if (data.type === 'complete') {
                                showStatus('‚úÖ G√©n√©ration termin√©e avec succ√®s!', 'success');
                            } else if (data.type === 'error') {
                                showStatus('‚ùå Erreur: ' + data.message, 'error');
                            }
                        } catch (e) {
                            // Pas du JSON, afficher comme texte
                            appendOutput(line);
                        }
                    }
                }

                if (buffer.trim()) {
                    try {
                        const data = JSON.parse(buffer);
                        if (data.type === 'complete') {
                            showStatus('‚úÖ G√©n√©ration termin√©e avec succ√®s!', 'success');
                        }
                    } catch (e) {
                        appendOutput(buffer);
                    }
                }
            } catch (error) {
                showStatus('‚ùå Erreur r√©seau: ' + error.message, 'error');
                appendOutput(`ERREUR: ${error.message}`);
            } finally {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '‚ú® Cr√©er les documents et mettre le site √† jour';
            }
        }
    </script>
</body>
</html>
