<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Debug HTML Generation</title>
</head>
<body>
    <h1>Test de génération HTML</h1>
    <div id="output"></div>
    <pre id="debug"></pre>

    <script>
        const text = "My name is John, and I am 15 years old. I go to high school.";
        const vocab = [
            {word: "name", translation: "nom"},
            {word: "school", translation: "école"}
        ];

        function normalizeWord(w) {
            let word = (w || '').toString();
            word = word.replace(/^(le|la|les|l'|der|die|das|el|los|las|un|una|uno|unos|unas|de|het|il|lo|gli|le|i|un'|l')\s+/i, '');
            word = word.replace(/^to\s+/i, '');
            word = word.replace(/\*/g, '');
            if (word.includes('→')) word = word.split('→')[0].trim();
            return word.trim();
        }

        function highlightVocabInText(text, vocabList) {
            let highlightedText = text;
            const transByWord = new Map();
            vocabList.forEach(item => {
                const key = normalizeWord(item.word).toLowerCase();
                if (key.length > 2 && !transByWord.has(key)) {
                    transByWord.set(key, (item.translation || '').toString());
                }
            });

            const uniqueWords = Array.from(transByWord.keys()).sort((a, b) => b.length - a.length);

            uniqueWords.forEach(word => {
                const escapedWord = word.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                const regex = new RegExp(`(^|[^\\wÀ-ÿ'])(${escapedWord})(?=$|[^\\wÀ-ÿ'])`, 'gi');

                highlightedText = highlightedText.replace(regex, (_m, p1, p2) => {
                    const k = normalizeWord(p2).toLowerCase();
                    let tr = transByWord.get(k) || '';
                    if (tr) {
                        tr = tr.replace(/"/g, '&quot;');
                    }
                    const titleAttr = tr ? ` title="${tr}"` : '';
                    const dataAttr = tr ? ` data-translation="${tr}"` : '';
                    return `${p1}<span class="vocab-highlight"${titleAttr}${dataAttr}>${p2}</span>`;
                });
            });

            return highlightedText;
        }

        const result = highlightVocabInText(text, vocab);
        
        document.getElementById('output').innerHTML = result;
        document.getElementById('debug').textContent = result;
        
        console.log("HTML généré:", result);
    </script>
</body>
</html>
